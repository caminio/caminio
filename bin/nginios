#!/usr/bin/env node

/*
 * nginios
 * (c) 2014 by TASTENWERK
 * license: GPLv3
 *
 */

var program = require('commander');
var prompt = require('prompt');
var colors = require('colors');
var fs = require('fs');
var child_process = require("child_process");
var nginios = require(__dirname+'/../');

program
  .version('0.0.1')
  .usage('new <app_name>')
  .option('new [name]', 'Create a new nginios application' )
  .on('new', function( name ){
      child_process.exec( 'express '+name, function( err, stderr, stdout ){
        console.log('\n\n');
        fs.mkdirSync( name+'/config' );
        console.log('[ok]'.green, (name+'/app').bold);

        fs.mkdirSync( name+'/app' );
        console.log('[ok]'.green, (name+'/app/controllers').bold);

        fs.mkdirSync( name+'/app/controllers' );
        fs.createReadStream(__dirname+'/../lib/install/app/controllers/main.js').pipe(fs.createWriteStream(name+'/app/controllers/main.js'));
        console.log('[ok]'.green, (name+'/app/views').bold);

        fs.mkdirSync( name+'/app/views' );
        fs.mkdirSync( name+'/app/views/main' );
        fs.createReadStream(__dirname+'/../lib/install/app/views/layout.jade').pipe(fs.createWriteStream(name+'/app/views/layout.jade'));
        fs.createReadStream(__dirname+'/../lib/install/app/views/main/index.jade').pipe(fs.createWriteStream(name+'/app/views/main/index.jade'));
        console.log('[ok]'.green, (name+'/app/models').bold);

        fs.mkdirSync( name+'/app/models' );
        console.log('[ok]'.green, (name+'/lib').bold);
        console.log('[ok]'.green, (name+'/config').bold);
        console.log('[ok]'.green, (name+'/public').bold);

        fs.createReadStream(__dirname+'/../lib/install/public/stylesheets/main.css').pipe(fs.createWriteStream(name+'/public/stylesheets/main.css'));
        fs.mkdirSync( name+'/config/environments' );
        fs.unlink( name+'/app.js' );
        fs.createReadStream(__dirname+'/../lib/install/app.js').pipe(fs.createWriteStream(name+'/app.js'));
        fs.createReadStream(__dirname+'/../lib/install/environments/development.js').pipe(fs.createWriteStream(name+'/config/environments/development.js'));
        fs.createReadStream(__dirname+'/../lib/install/environments/production.js').pipe(fs.createWriteStream(name+'/config/environments/production.js'));
        fs.createReadStream(__dirname+'/../lib/install/environments/test.js').pipe(fs.createWriteStream(name+'/config/environments/production.js'));
        fs.createReadStream(__dirname+'/../lib/install/routes.js').pipe(fs.createWriteStream(name+'/config/routes.js'));
        fs.createReadStream(__dirname+'/../lib/install/package.json').pipe(fs.createWriteStream(name+'/package.json'));
        console.log('\n\napplication', name.bold, 'created successfully'.green);
        });
      });

  program
  .usage('gear <name>')
  .option('gear [name]', 'Create a plain nginios gear folder' )
  .on('gear', function( name ){
      fs.mkdirSync( name );
      fs.createReadStream(__dirname+'/../lib/install/gear/package.json').pipe(fs.createWriteStream(name+'/package.json'));
      fs.createReadStream(__dirname+'/../lib/install/gear/index.js').pipe(fs.createWriteStream(name+'/index.js'));
      fs.createReadStream(__dirname+'/../lib/install/gear/Makefile').pipe(fs.createWriteStream(name+'/Makefile'));
      console.log('your gear', name.bold, 'is ready to use!'.green);
      });

  program
  .option('adduser [name] [domain]', 'add a user to a domain' )
  .usage('adduser kings.com henry')
  .on('adduser', function( name, domainName ){
    prompt.start();

    prompt.get([
      { 
        name: 'email',
        required: true
      },
      {
        name: 'password',
        hidden: true
      }
      ], function( err, result ){
        var app = nginios();
        new nginios.Gear();
        nginios.orm.models.Domain.find({ name: domainName }, function(err, domain){
          if( err ){ console.log(err); }
          if( domain )
          return createUser( domain, name, result.email, result.password );

          nginios.orm.models.Domain.create({ name: domainName }, function(err, domain){
            createUser( domain, name, result.email, result.password );
            });
          });
    });
  });

  program
  .option('setup [domainName]', 'add a user to a domain' )
  .usage('setup kings.com')
  .on('setup', function(domainName){

    console.log('attempting to create ', domainName.bold);

    var app = nginios();
    new nginios.Gear();
    nginios.orm.models.Domain.create({
      name: domainName,
      allowed_gears: [ 'nginios' ]
    }, function( err, domain ){
      if( err ){ return console.log( err ); }
      if( domain )
        return createUser( domain, 'Administrator', 'manager@'+domainName, 'mgr' );
    })
    
  });

function createUser( domain, name, email, password ){

  nginios.orm.models.User.create({ 
    name: { full: name }, 
    email: email,
    domains: [ domain ],
    password: password }, function( err, user ){
      if( err ){ return console.log(err); }
      if( user ){
        domain.owner = user;
        domain.users.push( user );
        domain.save( function( err ){
          if( err ){ return console.log(err); }
          console.log('User', name.bold, ' has been created'.green);
        })
      }
  });

}

program.parse(process.argv);
